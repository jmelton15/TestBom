pipeline {
    agent any

    stages {
        stage("Setup Temp Folders") {
            steps {
                script {
                    def cmd1 = 'mkdir BOM_FILES'
                    def cmd2 = 'mkdir Repos'

                    def process1 = bat(script:cmd1,returnStatus: true)
                    if(process1 == 0) {
                        echo "Created Bom File Folder"
                    } else {
                        echo "Creating Bom File Folder failed with code: ${process1}"
                    }
                    def process2 = bat(script:cmd2,returnStatus: true)
                    if(process2 == 0) {
                        echo "Created temp repo folder"
                    } else {
                        echo "Creating temp repo Folder failed with code: ${process2}"
                    }
                }
            }
        }
        stage('Read URLs File And Create Boms') {
            steps {
                script {
                    def fileContent = readFile 'urls.txt'

                    def lines = fileContent.readLines()

                    lines.each { line -> 
                        def lineParts = line.split('/')
                        def lastEle = lineParts.last()
                        def gitName = lastEle.substring(0,lastEle.length() - 4)
                    
                        def gitCmd = "git -C Repos/ clone ${line}"
                            
                        def cloneProcess = bat(script:gitCmd,returnStatus: true)

                        if(cloneProcess == 0) {
                            
                            def fileName = "BOM_FILES/sbom-${gitName}.json"
                            echo "HELLO LOSERS!"
                            def makeBomCmd = "cdxgen -o ${fileName} --spec-version 1.4"
                            echo "HELLO LOSERS Again!"
                            def cleanUpCmd = "rmdir /s /q ${Repos}"
                            echo "HELLO LOSERS One more Time!"
                            def bomCreationProcess = bat(script:makeBomCmd,returnStatus: true)
                            if(bomCreationProcess == 0) {
                                echo "HELLO LOSERS In Next Process!"
                                def cleanupProcess = bat(script:cleanUpCmd,returnStatus: true)

                                if(cleanupProcess == 0) {
                                    echo "Created Bom File for ${line} and cleaned up pulled repo"
                                } else {
                                    echo "Cleaning up pulled repo failed with code: ${process}"
                                }
                            } else {
                                echo "Creating bom file for ${line} failed with code: ${process}"
                            }
                        } else {
                            echo "Cloning repo ${line} failed with code: ${process}"
                        }
                    }
                }
            }
        }
    }
}